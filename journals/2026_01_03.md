## 使用Pandat导出MicroSim所需热力学数据
collapsed:: true
	- ((64465741-07d5-4238-a48f-8dbc8cba938d))
	  collapsed:: true
		- collapsed:: true
		  >参考
			- ((6959dd3a-75f6-4f7b-85d4-ab00cf0b022d))
- 当MicroSim GUI第四步的“Functional Properties”选择4模式时，需要用户提供Composition和HSN文件，这两个文件由Pandat或Thermo-Calc计算得到的dat文件转化而来
- 这里以Pandat为例，导入tdb文件，执行线计算（Line Calculation）；点击“Options”，弹出窗口中选择“Default Table”，勾选`x(*@*)`和`HSN(@*)`，这两个选项分别表示各相中各元素的平衡成分和Hessian矩阵，然后关闭弹出窗口；点击“Select Phases”选项，排除不参与计算的相（例如亚稳相和稳定相在相图中重叠时，排除稳定相，才能计算亚稳相）
- 计算完成得到几个表格，选择第一个default表，点击工具栏的“Table”-“Export to a Text File”，导出纯文本.dat文件
- 使用python脚本处理.dat文件，需要实现以下功能：1. 筛选出T、`x(*@*)`和`HSN(@*)`列，排除符号列；2. 根据MicroSim GUI中第二步填写的元素和相的顺序调整列的顺序，要求详见“MicroSim 中使用Function F=4的注意事项”条目；3. 导出csv文件，一个是“Composition_第一个析出相名称.csv”，其余是“HSN_各个相名称.csv”。以下是我的代码
  ``` python
  # 步骤1：分离两类目标列
  pattern_x = re.compile(r'x\(.*@.*\)')     # 匹配 x(*@*) 格式
  pattern_hsn = re.compile(r'HSN\(.*\)')     # 匹配 HSN(*) 格式
  
  # 筛选两类列名（排除'T'列）
  x_cols = [col for col in df.columns if pattern_x.search(col)]
  hsn_cols = [col for col in df.columns if pattern_hsn.search(col)]
  
  # 步骤2：调整元素和相的顺序
  exclude_elements = {'AL'}  # 溶剂元素
  phase_order = ['L12', 'FCC_A1']  # 先析出相，最后基体相
  element_order = ['LI']  # 溶质元素
  
  # 动态解析列结构
  phase_element_map = []
  for col in x_cols:
      # 使用正则捕获组精准提取元素和相名
      match = re.match(r'x\(([^@]+)@([^)]+)\)', col)  
      if match:
          element, phase = match.groups()
          if element not in exclude_elements:
              phase_element_map.append( (phase, element, col) )
  
  # 双维度排序函数
  def custom_sort_key(item):
      phase, element, _ = item
      phase_priority = phase_order.index(phase) if phase in phase_order else len(phase_order)
      element_priority = element_order.index(element) if element in element_order else len(element_order)
      return (phase_priority, element_priority)
  
  # 执行排序并生成最终列序列
  sorted_cols = sorted(phase_element_map, key=custom_sort_key)
  final_x_cols = [col for _, _, col in sorted_cols]
  
  # 导出组合文件
  selected_cols = ['T'] + final_x_cols + hsn_cols
  df_filtered = df[selected_cols].drop(index=0).dropna(subset=selected_cols)
  df_filtered[final_x_cols] = (df_filtered[final_x_cols].astype(float)*0.01).round(6)
  
  # 步骤3：导出平衡组成文件（合并x列组）
  comps_name = ''.join(["_" + phase_order[0]])
  output_file1 = os.path.join(output_path, "Composition"+ comps_name +".csv")
  df_filtered[['T'] + final_x_cols].to_csv(output_file1, index=False, encoding='utf-8-sig')
  
  # 步骤4：批量导出HSN矩阵文件（每个相的HSN单独导出）
  for col in hsn_cols:
      # 清理列名中的危险字符（Windows文件名限制）
      no_special = re.sub(r'[()<>@:"/\\|?*]', '', col)
      safe_name = no_special[:3] + '_' + no_special[3:]
      output_file2 = os.path.join(output_path, f"{safe_name}.csv")
      df_filtered[['T', col]].to_csv(output_file2, index=False, encoding='utf-8-sig')
  ```