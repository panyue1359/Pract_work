## CentOS安装Apptainer并供普通用户使用（失败）
id:: 690f16cb-da71-4959-a7d5-271154d345c1
collapsed:: true
	- ((69202eab-d4f0-48e6-8c09-9ddb00b57ab6))
- 系统：CentOS 7.5.1804，Linux内核版本3.10.0-862.el7.x86_64
- Apptainer和Docker类似也是一种容器技术，Apptainer的安全性更高、非root用户可以直接安装使用，不需要以root权限运行守护进程，普遍用于学术领域
- #+BEGIN_PINNED
  脚本+rpm安装
  #+END_PINNED
- 下载[官方rpm安装脚本](https://raw.githubusercontent.com/apptainer/apptainer/main/tools/install-unprivileged.sh)和[apptainer-1.1.4-1.x86_64.rpm安装包](https://github.com/apptainer/apptainer/releases/tag/v1.1.4)到服务器 [Installing Apptainer — Apptainer Admin Guide main documentation](https://apptainer.org/docs/admin/main/installation.html#install-unprivileged-from-pre-built-binaries)
  logseq.order-list-type:: number
- 在服务器上执行`./install-unprivileged.sh -v apptainer-1.1.4-1.x86_64.rpm Apptainer`，安装apptainer到Apptainer目录
  logseq.order-list-type:: number
	- 中间可能会失败，重试几次即可
	  logseq.order-list-type:: number
- 执行`echo 'export PATH="Apptainer/bin:$PATH"' >> ~/.bashrc`和`echo 'export LD_LIBRARY_PATH="Apptainer/x86_64/utils/lib:$LD_LIBRARY_PATH"' >> ~/.bashrc` 添加环境变量
  logseq.order-list-type:: number
- 执行`apptainer --version`查看版本
  logseq.order-list-type:: number
- 执行`apptainer shell apptainer镜像路径`创建容器
  logseq.order-list-type:: number
	- apptainer创建容器需要管理员安装`set-uid`或者启动namespace功能，CentOS 7.4系统的namespace功能默认关闭，需要在管理员用户执行`echo 10000 > /proc/sys/user/max_user_namespaces`然后执行`reboot`重启服务器，以开启该功能 [CentOS 7 启用 user namespaces（用户命名空间） - 操作系统 - 123si 博客](https://www.123si.org/os/article/centos-7-enable-user-namespaces/)
- #+BEGIN_WARNING
  问题
  #+END_WARNING
- 安装1.1.4版本并开启namespace功能，创建容器时提示`mount hook function failure:'GLIBC_2.28' not found`
- 内核版本不能太低，至少要3.10.0-1160.76.1.el7.x86_64 [cannot run with user namespace, fuse error · Issue #778 · apptainer/apptainer](https://github.com/apptainer/apptainer/issues/778#_prevue)
- 添加apptainer环境变量后SFTP不可用，`vi`指令不可用，删除环境变量后恢复正常
- ## Docker镜像转为Apptainer镜像
  collapsed:: true
	- ((66330953-30ba-4733-b613-5ba891d66493))
	  collapsed:: true
		- collapsed:: true
		  >参考
			- ((690f16cb-da71-4959-a7d5-271154d345c1))
- 系统：CentOS 7.5.1804，Linux内核版本3.10.0-862.el7.x86_64
- Apptainer没有镜像商店，需要将Docker镜像转为Apptainer镜像（.sif）才能使用
- #+BEGIN_PINNED
  本地转换
  #+END_PINNED
- 导出Docker镜像为压缩包（.tar），执行`apptainer build apptainer镜像名.sif docker-archive:Docker镜像路径`转换