## 使用Singularity创建OpenFOAM容器并编译求解器
collapsed:: true
	- ((69202eab-d4f0-48e6-8c09-9ddb00b57ab6)), ((6920303d-008c-421a-9bae-d436739cb759))
	  collapsed:: true
		- collapsed:: true
		  >参考
			- ((692aecdb-fb01-42b6-acc0-4b8f811e4a7a))
- Singularity没有镜像的概念，代之以两种容器：沙箱（sandbox）和只读容器（sif文件）。沙箱是一个文件夹，可以以交互式且可写入的方式修改内容，也可以直接修改内容。只读容器是一个压缩文件，不能修改内容。Singularity默认以系统当前用户身份进入容器，工作目录为当前所在的目录，无论是普通方式登录还是`--fakeroot`方式登录用户名均显示“Singularity”，可使用`whoami`查看用户名 [Singularity 日常使用指南 · XTAO Achelous](http://www.achelous.org/Container-Tech/Singularity-in-nutshell.html#_prevue)
- Docker镜像转Singularity容器：导出OpenFOAM的Docker镜像为tar文件，创建Singularity沙箱 `singularity build --sandbox openfoam2406 docker-archive://openfoam2406.tar`；若不需要修改，可执行`singularity build openfoam2406.sif docker-archive://openfoam2406.tar`直接创建只读容器
  logseq.order-list-type:: number
- 修改沙箱：以交互方式且可修改方式进入沙箱 `singularity run --writable --fakeroot openfoam2406`或简写为`singularity run -wf openfoam2406`
  logseq.order-list-type:: number
	- 如果需要以root权限执行一些命令（如sudo apt install），则修改沙箱时添加`--fakeroot`参数，这需要启用namespace功能并添加当前用户到singularity用户组，详见“CentOS安装Singularity并供普通用户使用”条目
	- 编译完成执行`whereis 求解器名称`查看编译位置，然后复制到OpenFOAM安装目录下，例如
	  ``` bash
	  whereis multiRegionPhaseChangeFlow
	  > multiRegionPhaseChangeFlow: /root/OpenFOAM/centos-v2406/platforms/linux64GccDPInt32Opt/bin/multiRegionPhaseChangeFlow
	  whereis icoFoam
	  > icoFoam: /usr/lib/openfoam/openfoam2406/platforms/linux64GccDPInt32Opt/bin/icoFoam
	  cp -n -r -u /root/OpenFOAM/centos-v2406/platforms/linux64GccDPInt32Opt/ /usr/lib/openfoam/openfoam2406/platforms/linux64GccDPInt32Opt/
	  ```
- 保存沙箱为sif：修改完成将沙箱保存为只读格式的容器 `singularity build twophase2406.sif openfoam2406`
  logseq.order-list-type:: number
- 启动只读容器：以交互方式进入只读容器 `singularity shell 只读容器`；对于OpenFOAM来说，使用`run`方式直接启动OpenFOAM命令行更为便捷 `singularity run twophase2406.sif`，相当于`singularity exec twophase2406.sif openfoam`或shell启动后再执行`openfoam`命令
  logseq.order-list-type:: number
	- singularity会自动挂载当前用户home目录到容器中，如需挂载其他目录，可添加参数`--bind 容器目录:主机目录`