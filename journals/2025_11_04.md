## 服务器架构、Docker与Open MPI
collapsed:: true
	- ((66330953-30ba-4733-b613-5ba891d66493))
	  collapsed:: true
		- collapsed:: true
		  >参考
			- ((68479c8f-62ed-461d-b0c1-6f77eaa20f9a))
- NUMA架构为多个卡槽（socket）组成计算机集群，一个socket加上与之相连的内存、网卡等组成一个节点（node），可使用命令`numactl -H`查看节点信息。 [CPU进程绑定以及对MPI+OMP混合并行的影响_omp绑核-CSDN博客](https://blog.csdn.net/csdnzzt/article/details/148772927)
- 使用指令`lscpu`查看计算资源，服务器通常默认关闭超线程，即`Thread(s) per core:    1`，物理核数=插槽数(`Socket(s):`)*每个插槽的核数(`Core(s) per socket:`)
- Open MPI可以使用`--bind-to`将进程与节点中的各种对象（core、socket、numa等）绑定或者使用`--map-by`进行映射，`--map-by ppr:4:socket`表示将四个进程映射到一个socket中，`--map-by ppr:2:socket:pe=2`表示将两个进程映射到一个socket中，每个核对应2个进程，详见 [mpi - Syntax of the --map-by option in openmpi mpirun v1.8 - Stack Overflow](https://stackoverflow.com/questions/28216897/syntax-of-the-map-by-option-in-openmpi-mpirun-v1-8)
- 有人测试了NUMA架构服务器上不同进程绑定和映射组合的计算效率，结论是`--bind-to socket`比`--bind-to core`要好 [正确运行并发 openmpi 作业：r/HPC --- Properly running concurrent openmpi jobs : r/HPC](https://www.reddit.com/r/HPC/comments/188ajt3/comment/kbphm7k/)
- Docker创建容器时可使用参数`--cpuset-cpus=`指定CPU核心，例如`--cpuset-cpus='0-9'`表示只使用0-9号CPU核心 [Docker: 限制容器可用的 CPU - sparkdev - 博客园](https://www.cnblogs.com/sparkdev/p/8052522.html)
- ## OpenFOAM的Open MPI参数设置
  collapsed:: true
	- ((68274234-f87f-4ce0-865f-2164130b5fd0))
- Dr. Donald Kinghorn在两个服务器上测试了不同核数、并行计算参数（bind-to和map-by）以及分块方法的效果。总体上核数越多效率越高；添加参数可能提升效率，也可能报错；分块方法对效率影响很小。 [OpenFOAM performance on Quad socket Xeon and Opteron | Puget Systems](https://www.pugetsystems.com/labs/hpc/OpenFOAM-performance-on-Quad-socket-Xeon-and-Opteron-587/)
- 总体上，随着核数增加，效率的提升呈现边际递减，不加参数甚至出现衰退。添加参数`--bind-to core` 可以防止效率衰退。**20核**左右，添加或者不添加参数效率都非常接近。 [Get the most of parallel simulations [mpi flags] -- CFD Online Discussion Forums](https://www.cfd-online.com/Forums/openfoam-solving/177503-get-most-parallel-simulations-mpi-flags.html)